Bootstrap: library
From: ubuntu:20.04
Stage: build

%setup
mkdir -p ${SINGULARITY_ROOTFS}/opt
cd ${SINGULARITY_ROOTFS}/opt
git clone https://github.com/delta9000/websockify.git
cd websockify
git checkout port_file_feature
cd ${SINGULARITY_ROOTFS}/opt
wget https://github.com/novnc/noVNC/archive/refs/tags/v1.2.0.tar.gz
tar xvf v1.2.0.tar.gz

%files


%environment
    export LISTEN_PORT=12345
    export LC_ALL=C
    export DISPLAY=:999

%post
    export DEBIAN_FRONTEND=noninteractive
    echo deb http://us.archive.ubuntu.com/ubuntu focal universe >> /etc/apt/sources.list
    apt-get update && apt-get install --no-install-recommends -y ca-certificates python3 python3-setuptools tigervnc-standalone-server openbox supervisor ssh xauth tigervnc-common

    cd /opt/websockify
    python3 setup.py install
    BUULD_DATE=`date`
    echo "export BUILD_DATE=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

%runscript
    export DISPLAY=:999
    export XAUTHORITY=/tmp/.Xauthority
    touch /tmp/.Xauthority
    xauth add ${HOST}:999 . $(xxd -l 16 -p /dev/urandom)
    sleep 1
    printf "password\npassword\n\n" | vncpasswd /tmp/.vncpasswd
    chown 600 /tmp/.vncpasswd
    Xvnc -nolisten tcp -nolisten local -rfbunixpath=/tmp/.vncsocket -rfbauth /tmp/.vncpasswd $DISPLAY &> /tmp/vnclog &
    sleep 5
    chmod 600 /tmp/.X11-unix/X999 && chmod 600 /tmp/.vncsocket
    /usr/local/bin/websockify --portfd=/tmp/.novncport --web=/opt/noVNC-1.2.0/ --unix-target=/tmp/.vncsocket --file_only 0 &> /tmp/novnclog &
    sleep 5
    openbox &> /tmp/openboxlog &
    sleep 5
    ssh -X $USER@localhost "$@" &> /tmp/execlog &
    sleep 5
    printf "Connect to http://%s:%s/vnc.html\n" `hostname` `cat /tmp/.novncport`
    


%test
    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
    fi

%labels
    Author bsandbro@vt.edu
    Version v0.0.1

%help
    This container wraps an Xvnc server with an openbox WM and exposes 
    supported sections.